<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="public/vite.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - PurePlates</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
      }

      .sidebar {
        background: linear-gradient(135deg, #2d5016 0%, #6b8e23 100%);
        color: white;
        padding: 30px 20px;
        display: flex;
        flex-direction: column;
      }

      .sidebar-logo {
        font-size: 1.4em;
        font-weight: bold;
        margin-bottom: 40px;
        text-align: center;
      }

      .sidebar-menu {
        flex: 1;
      }

      .sidebar-menu ul {
        list-style: none;
      }

      .sidebar-menu li {
        margin-bottom: 15px;
      }

      .sidebar-menu a {
        color: white;
        text-decoration: none;
        padding: 12px;
        display: block;
        border-radius: 6px;
        transition: all 0.3s;
      }

      .sidebar-menu a:hover,
      .sidebar-menu a.active {
        background: rgba(255, 255, 255, 0.2);
      }

      .logout-button {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        width: 100%;
      }

      .logout-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .main-content {
        padding: 30px;
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-header h1 {
        color: #2d5016;
        margin-bottom: 10px;
      }

      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .action-bar button {
        background: linear-gradient(135deg, #2d5016 0%, #6b8e23 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      .action-bar button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(45, 80, 22, 0.3);
      }

      .search-box {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        width: 250px;
        font-size: 1em;
      }

      .table-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #f0f0f0;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #2d5016;
        border-bottom: 2px solid #ddd;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f9f9f9;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .btn-edit,
      .btn-delete {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        font-size: 0.9em;
      }

      .btn-edit {
        background: #4CAF50;
        color: white;
      }

      .btn-edit:hover {
        background: #45a049;
      }

      .btn-delete {
        background: #f44336;
        color: white;
      }

      .btn-delete:hover {
        background: #da190b;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        color: #2d5016;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #999;
      }

      .close-button:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1em;
        font-family: inherit;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2d5016;
        box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
      }

      .modal-footer button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
      }

      .btn-save {
        background: linear-gradient(135deg, #2d5016 0%, #6b8e23 100%);
        color: white;
      }

      .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(45, 80, 22, 0.3);
      }

      .btn-cancel {
        background: #ccc;
        color: #333;
      }

      .btn-cancel:hover {
        background: #999;
      }

      .message {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #f5c6cb;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .empty-state p {
        margin-bottom: 20px;
      }

      .section {
        display: none;
      }

      .section.active {
        display: block;
      }

      .nav-link {
        cursor: pointer !important;
      }

      .nav-link.active {
        background: rgba(255, 255, 255, 0.2) !important;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-logo">üçΩÔ∏è PurePlates Admin</div>
        <div class="sidebar-menu">
          <ul>
            <li><a href="#menu" class="nav-link active" onclick="showSection('menu')">üìã Menu Items</a></li>
            <li><a href="#orders" class="nav-link" onclick="showSection('orders')">üì¶ Orders</a></li>
            <li><a href="#reservations" class="nav-link" onclick="showSection('reservations')">üìÖ Reservations</a></li>
          </ul>
        </div>
        <button class="logout-button" onclick="handleLogout()">üö™ Logout</button>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Menu Items Section -->
        <div id="menuSection" class="section">
          <div class="page-header">
            <h1>Menu Items Management</h1>
            <p>Create, update, and delete menu items</p>
          </div>

          <div id="messageContainer"></div>

          <div class="action-bar">
            <input type="text" class="search-box" id="searchBox" placeholder="Search menu items...">
            <button onclick="openAddItemModal()">‚ûï Add New Item</button>
          </div>

          <div class="table-container">
            <table id="itemsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Price (Rs.)</th>
                  <th>Category</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="section">
          <div class="page-header">
            <h1>Orders Management</h1>
            <p>View and manage customer orders</p>
          </div>

          <!-- Revenue Summary Card -->
          <div id="revenueCard" style="background: linear-gradient(135deg, #2d5016 0%, #6b8e23 100%); color: white; padding: 25px 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
              <div>
                <h3 style="margin: 0 0 8px 0; font-size: 0.95em; opacity: 0.9; font-weight: 500;">Total Revenue</h3>
                <p id="totalRevenue" style="margin: 0; font-size: 2.2em; font-weight: bold;">Rs. 0.00</p>
              </div>
              <div style="text-align: right;">
                <h3 style="margin: 0 0 8px 0; font-size: 0.95em; opacity: 0.9; font-weight: 500;">Total Orders</h3>
                <p id="totalOrdersCount" style="margin: 0; font-size: 2.2em; font-weight: bold;">0</p>
              </div>
            </div>
          </div>

          <div class="action-bar" style="justify-content: flex-end;">
            <button onclick="loadOrders()" style="background: #6b8e23; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üîÑ Refresh Orders</button>
            <label style="margin-left: 20px; display: flex; align-items: center; gap: 8px; color: #333; cursor: pointer;">
              <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
              Auto-refresh (30s)
            </label>
          </div>

          <div class="table-container">
            <table id="ordersTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Address</th>
                  <th>Items</th>
                  <th>Total (Rs.)</th>
                  <th>Payment</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <tr><td colspan="10" style="text-align: center; padding: 40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Reservations Section -->
        <div id="reservationsSection" class="section">
          <div class="page-header">
            <h1>Reservations Management</h1>
            <p>View and manage table reservations</p>
          </div>

          <div class="action-bar" style="justify-content: flex-end;">
            <button onclick="loadReservations()" style="background: #6b8e23; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üîÑ Refresh Reservations</button>
          </div>

          <div class="table-container">
            <table id="reservationsTable">
              <thead>
                <tr>
                  <th>Reservation ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Guests</th>
                  <th>Occasion</th>
                  <th>Special Requests</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="reservationsTableBody">
                <tr><td colspan="10" style="text-align: center; padding: 40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add New Item</h2>
          <button class="close-button" onclick="closeItemModal()">‚úï</button>
        </div>

        <form id="itemForm" onsubmit="handleSaveItem(event)">
          <div class="form-group">
            <label for="itemName">Item Name *</label>
            <input type="text" id="itemName" placeholder="e.g., Garden Fresh Salad" required>
          </div>

          <div class="form-group">
            <label for="itemDescription">Description *</label>
            <textarea id="itemDescription" placeholder="e.g., Mixed greens with fresh vegetables" rows="3" required></textarea>
          </div>

          <div class="form-group">
            <label for="itemPrice">Price (Rs.) *</label>
            <input type="number" id="itemPrice" placeholder="e.g., 1200" min="0" step="1" required>
          </div>

          <div class="form-group">
            <label for="itemCategory">Category *</label>
            <select id="itemCategory" required>
              <option value="">Select Category</option>
              <option value="Appetizers">Appetizers</option>
              <option value="Main Courses">Main Courses</option>
              <option value="Desserts">Desserts</option>
              <option value="Beverages">Beverages</option>
            </select>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeItemModal()">Cancel</button>
            <button type="submit" class="btn-save">Save Item</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
      <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
          <h2>Confirm Delete</h2>
          <button class="close-button" onclick="closeConfirmModal()">‚úï</button>
        </div>

        <p style="margin-bottom: 20px; color: #666;">Are you sure you want to delete this item? This action cannot be undone.</p>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
          <button type="button" class="btn-delete" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>

    <!-- Reservation Modal -->
    <div id="reservationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="reservationModalTitle">Edit Reservation</h2>
          <button class="close-button" onclick="closeReservationModal()">‚úï</button>
        </div>

        <form id="reservationForm" onsubmit="handleSaveReservation(event)">
          <div class="form-group">
            <label for="resName">Name *</label>
            <input type="text" id="resName" placeholder="e.g., John Doe" required>
          </div>

          <div class="form-group">
            <label for="resEmail">Email *</label>
            <input type="email" id="resEmail" placeholder="e.g., john@example.com" required>
          </div>

          <div class="form-group">
            <label for="resPhone">Phone *</label>
            <input type="tel" id="resPhone" placeholder="e.g., 9876543210" required>
          </div>

          <div class="form-group">
            <label for="resDate">Reservation Date *</label>
            <input type="date" id="resDate" required>
          </div>

          <div class="form-group">
            <label for="resTime">Reservation Time *</label>
            <input type="time" id="resTime" required>
          </div>

          <div class="form-group">
            <label for="resGuests">Number of Guests *</label>
            <input type="number" id="resGuests" placeholder="e.g., 4" min="1" required>
          </div>

          <div class="form-group">
            <label for="resOccasion">Occasion</label>
            <input type="text" id="resOccasion" placeholder="e.g., Birthday, Anniversary">
          </div>

          <div class="form-group">
            <label for="resRequests">Special Requests</label>
            <textarea id="resRequests" placeholder="e.g., Vegetarian options needed" rows="3"></textarea>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeReservationModal()">Cancel</button>
            <button type="submit" class="btn-save">Save Reservation</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let currentItemId = null;
      let itemToDelete = null;
      let allItems = [];
      let allOrders = [];
      let allReservations = [];
      let autoRefreshInterval = null;

      // Show/hide sections
      function showSection(sectionName) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionName + 'Section').classList.add('active');
        
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        event.target.classList.add('active');

        if (sectionName === 'orders') {
          loadOrders();
        } else if (sectionName === 'menu') {
          loadMenuItems();
        } else if (sectionName === 'reservations') {
          loadReservations();
        }
      }

      // Check if user is logged in
      function checkAuth() {
        const token = sessionStorage.getItem('admin_token');
        if (!token) {
          window.location.href = 'admin.html';
        }
      }

      // Load menu items on page load
      function loadMenuItems() {
        console.log('üìã Loading menu items...');
        fetch('/api/menu-items')
          .then(async response => {
            console.log('üìã Response status:', response.status);
            if (!response.ok) {
              let errorMsg = `HTTP ${response.status}`;
              try {
                const err = await response.json();
                errorMsg = err.error || errorMsg;
              } catch (e) {
                errorMsg = await response.text() || errorMsg;
              }
              throw new Error(errorMsg);
            }
            return response.json();
          })
          .then(data => {
            console.log('üìã Menu items data:', data);
            if (data.success && data.items) {
              allItems = data.items;
              displayItems(allItems);
              console.log(`‚úÖ Loaded ${allItems.length} menu items`);
            } else if (Array.isArray(data)) {
              // Handle case where API returns array directly
              allItems = data;
              displayItems(allItems);
              console.log(`‚úÖ Loaded ${allItems.length} menu items (array format)`);
            } else {
              console.error('‚ùå Unexpected data format:', data);
              showMessage('Error loading menu items: Unexpected response format', 'error');
              document.getElementById('itemsTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f44336;">‚ö†Ô∏è Error loading menu items</td></tr>';
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading menu items:', error);
            showMessage('Error loading menu items: ' + error.message, 'error');
            document.getElementById('itemsTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f44336;">‚ö†Ô∏è Error: ' + error.message + '</td></tr>';
          });
      }

      // Load orders
      function loadOrders() {
        console.log('üì¶ Loading orders from /api/orders...');
        fetch('/api/orders', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          console.log('üì¶ Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('üì¶ Full response data:', data);
          
          // Check if data is array directly or wrapped in success/items
          let orders = [];
          if (Array.isArray(data)) {
            orders = data;
            console.log('üì¶ Data is direct array');
          } else if (data.items && Array.isArray(data.items)) {
            orders = data.items;
            console.log('üì¶ Data has items array');
          } else {
            console.log('‚ö†Ô∏è Unexpected data format:', data);
          }
          
          console.log(`üì¶ Total orders loaded: ${orders.length}`);
          allOrders = orders;
          displayOrders(allOrders);
          
          if (allOrders.length > 0) {
            showMessage(`‚úÖ ${allOrders.length} order(s) loaded from database`, 'success');
          }
        })
        .catch(error => {
          console.error('‚ùå Error loading orders:', error);
          showMessage('Error loading orders: ' + error.message, 'error');
          document.getElementById('ordersTableBody').innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #f44336;">‚ö†Ô∏è Error loading orders from database: ' + error.message + '</td></tr>';
        });
      }

      // Display items in table
      function displayItems(items) {
        const tbody = document.getElementById('itemsTableBody');
        
        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><p>No menu items found. Click "Add New Item" to create one.</p></td></tr>';
          return;
        }

        tbody.innerHTML = items.map(item => `
          <tr>
            <td>#${item.id}</td>
            <td><strong>${escapeHtml(item.name)}</strong></td>
            <td>${escapeHtml(item.description)}</td>
            <td>Rs. ${item.price.toLocaleString('en-IN')}</td>
            <td><span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">${escapeHtml(item.category)}</span></td>
            <td>
              <div class="action-buttons">
                <button class="btn-edit" onclick="openEditItemModal(${item.id})">Edit</button>
                <button class="btn-delete" onclick="openDeleteConfirm(${item.id})">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      // Display orders in table
      function displayOrders(orders) {
        console.log('üìã Displaying orders. Count:', orders ? orders.length : 0);
        const tbody = document.getElementById('ordersTableBody');
        
        // Calculate total revenue
        const totalAmount = orders && orders.length > 0 
          ? orders.reduce((sum, order) => sum + (parseFloat(order.total_price) || 0), 0) 
          : 0;
        
        // Update revenue card
        const revenueElement = document.getElementById('totalRevenue');
        const ordersCountElement = document.getElementById('totalOrdersCount');
        if (revenueElement) {
          revenueElement.textContent = `Rs. ${totalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        if (ordersCountElement) {
          ordersCountElement.textContent = orders ? orders.length : 0;
        }
        
        if (!orders || orders.length === 0) {
          console.log('üì≠ No orders to display');
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">üì≠ No orders in database yet. Orders will appear here when customers place them.</td></tr>';
          return;
        }

        let rowsHTML = '';
        
        orders.forEach((order, index) => {
          console.log(`üì¶ Processing order ${index + 1}:`, order);
          
          // Parse items safely
          let itemsText = '';
          let itemCount = 0;
          try {
            const items = JSON.parse(order.items);
            if (Array.isArray(items)) {
              itemsText = items.map(item => `${escapeHtml(item.name)} (x${item.quantity})`).join('<br/>');
              itemCount = items.length;
            }
          } catch (e) {
            itemsText = order.items || 'N/A';
            console.log('‚ö†Ô∏è Could not parse items for order', order.id);
          }

          // Format date
          let orderDate = 'N/A';
          if (order.order_date) {
            try {
              orderDate = new Date(order.order_date).toLocaleDateString('en-IN', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            } catch (e) {
              orderDate = order.order_date;
            }
          }

          // Payment method label
          const paymentLabel = {
            'credit_card': 'üí≥ Credit/Debit Card',
            'cod': 'üíµ Cash on Delivery',
            'wallet': 'üì± Digital Wallet'
          }[order.payment_method] || order.payment_method;

          // Status styling
          const statusStyle = {
            'Pending': { bg: '#ff9800', text: '‚è≥ Pending' },
            'Confirmed': { bg: '#4CAF50', text: '‚úÖ Confirmed' },
            'Completed': { bg: '#2196F3', text: 'üì¶ Completed' },
            'Cancelled': { bg: '#f44336', text: '‚ùå Cancelled' }
          };
          const status = statusStyle[order.order_status] || { bg: '#999', text: order.order_status };

          rowsHTML += `
            <tr style="border-bottom: 2px solid #eee;">
              <td style="padding: 12px;"><strong>#${order.id}</strong></td>
              <td style="padding: 12px;"><strong>${escapeHtml(order.customer_name)}</strong></td>
              <td style="padding: 12px; font-size: 0.9em;">${escapeHtml(order.customer_email)}</td>
              <td style="padding: 12px; font-size: 0.9em;">${escapeHtml(order.customer_phone)}</td>
              <td style="padding: 12px; font-size: 0.85em;">
                <strong>${escapeHtml(order.street_address)}</strong><br/>
                ${escapeHtml(order.city)} - ${escapeHtml(order.zip_code)}
                ${order.special_instructions ? `<br/><em style="color: #666;">Note: ${escapeHtml(order.special_instructions)}</em>` : ''}
              </td>
              <td style="padding: 12px; font-size: 0.85em; max-width: 200px; overflow-y: auto; max-height: 80px;">${itemsText}</td>
              <td style="padding: 12px;"><strong>Rs. ${parseFloat(order.total_price).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
              <td style="padding: 12px; font-size: 0.9em;">${paymentLabel}</td>
              <td style="padding: 12px;">
                <select onchange="updateOrderStatus(${order.id}, this.value)" style="padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-weight: bold; background: ${status.bg}; color: white; cursor: pointer;">
                  <option value="Pending" ${order.order_status === 'Pending' ? 'selected' : ''}>‚è≥ Pending</option>
                  <option value="Confirmed" ${order.order_status === 'Confirmed' ? 'selected' : ''}>‚úÖ Confirmed</option>
                  <option value="Completed" ${order.order_status === 'Completed' ? 'selected' : ''}>üì¶ Completed</option>
                  <option value="Cancelled" ${order.order_status === 'Cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                </select>
              </td>
              <td style="padding: 12px;">
                <div class="action-buttons">
                  <button class="btn-delete" onclick="openDeleteOrderConfirm(${order.id})">Delete</button>
                </div>
              </td>
            </tr>
          `;
        });

        // Add summary row at the bottom of the table
        const summary = `
          <tr style="background: #f0f8ff; font-weight: bold;">
            <td colspan="6" style="padding: 15px; text-align: right;">Total Orders: ${orders.length} | Total Revenue:</td>
            <td style="padding: 15px; background: #fffacd; color: #2d5016;">Rs. ${totalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td colspan="3"></td>
          </tr>
        `;
        
        tbody.innerHTML = rowsHTML + summary;
        console.log(`‚úÖ Displayed ${orders.length} orders with total revenue: Rs. ${totalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
      }

      // Open modal to add new item
      function openAddItemModal() {
        currentItemId = null;
        document.getElementById('itemForm').reset();
        document.getElementById('modalTitle').textContent = 'Add New Item';
        document.getElementById('itemModal').classList.add('show');
      }

      // Open modal to edit item
      function openEditItemModal(id) {
        const item = allItems.find(i => i.id === id);
        if (!item) return;

        currentItemId = id;
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemDescription').value = item.description;
        document.getElementById('itemPrice').value = item.price;
        document.getElementById('itemCategory').value = item.category;
        document.getElementById('modalTitle').textContent = 'Edit Item';
        document.getElementById('itemModal').classList.add('show');
      }

      // Close modal
      function closeItemModal() {
        document.getElementById('itemModal').classList.remove('show');
        currentItemId = null;
      }

      // Save item (create or update)
      function handleSaveItem(event) {
        event.preventDefault();

        const name = document.getElementById('itemName').value;
        const description = document.getElementById('itemDescription').value;
        const price = document.getElementById('itemPrice').value;
        const category = document.getElementById('itemCategory').value;
        const token = sessionStorage.getItem('admin_token');

        if (!token) {
          showMessage('You must be logged in to perform this action', 'error');
          window.location.href = 'admin.html';
          return;
        }

        const itemData = { name, description, price: parseInt(price), category };
        const method = currentItemId ? 'PUT' : 'POST';
        const url = currentItemId ? `/api/menu-items/${currentItemId}` : '/api/menu-items';

        console.log(`${currentItemId ? '‚úèÔ∏è Updating' : '‚ú® Creating'} menu item:`, itemData);

        fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(itemData)
        })
        .then(async response => {
          console.log('üì° Response status:', response.status);
          if (!response.ok) {
            let errorMsg = `HTTP ${response.status}`;
            try {
              const err = await response.json();
              errorMsg = err.error || errorMsg;
            } catch (e) {
              errorMsg = await response.text() || errorMsg;
            }
            throw new Error(errorMsg);
          }
          return response.json();
        })
        .then(data => {
          console.log('üì° Response data:', data);
          if (data.success) {
            closeItemModal();
            loadMenuItems();
            showMessage(currentItemId ? 'Item updated successfully' : 'Item created successfully', 'success');
          } else {
            showMessage(data.error || 'Error saving item', 'error');
          }
        })
        .catch(error => {
          console.error('‚ùå Error saving item:', error);
          showMessage('Error saving item: ' + error.message, 'error');
        });
      }

      // Delete confirmation
      function openDeleteConfirm(id) {
        itemToDelete = id;
        document.getElementById('confirmModal').classList.add('show');
      }

      function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('show');
        itemToDelete = null;
      }

      function confirmDelete() {
        if (!itemToDelete) return;

        const token = sessionStorage.getItem('admin_token');
        
        if (!token) {
          showMessage('You must be logged in to perform this action', 'error');
          window.location.href = 'admin.html';
          return;
        }

        console.log(`üóëÔ∏è Deleting menu item #${itemToDelete}`);

        fetch(`/api/menu-items/${itemToDelete}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(async response => {
          console.log('üì° Response status:', response.status);
          if (!response.ok) {
            let errorMsg = `HTTP ${response.status}`;
            try {
              const err = await response.json();
              errorMsg = err.error || errorMsg;
            } catch (e) {
              errorMsg = await response.text() || errorMsg;
            }
            throw new Error(errorMsg);
          }
          return response.json();
        })
        .then(data => {
          console.log('üì° Response data:', data);
          if (data.success) {
            closeConfirmModal();
            loadMenuItems();
            showMessage('Item deleted successfully', 'success');
          } else {
            showMessage(data.error || 'Error deleting item', 'error');
          }
        })
        .catch(error => {
          console.error('‚ùå Error deleting item:', error);
          showMessage('Error deleting item: ' + error.message, 'error');
        });
      }

      // Toggle auto-refresh
      function toggleAutoRefresh() {
        const toggle = document.getElementById('autoRefreshToggle');
        if (toggle.checked) {
          autoRefreshInterval = setInterval(() => {
            loadOrders();
          }, 30000); // Refresh every 30 seconds
          console.log('‚úÖ Auto-refresh enabled');
        } else {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('‚ùå Auto-refresh disabled');
        }
      }

      // Load Reservations
      function loadReservations() {
        console.log('üîÑ Loading reservations...');
        const token = sessionStorage.getItem('admin_token');
        console.log('üìå Token retrieved:', token ? '‚úÖ Present' : '‚ùå Missing');
        
        if (!token) {
          console.error('‚ùå No admin token found! Redirecting to login...');
          window.location.href = 'admin.html';
          return;
        }

        fetch('/api/reservations-admin', {
          method: 'GET',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          console.log('üì° Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP Error: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('üìä Reservations data:', data);
          
          let reservations = [];
          if (Array.isArray(data)) {
            reservations = data;
            console.log('‚úÖ Data is array with', reservations.length, 'items');
          } else if (data.reservations && Array.isArray(data.reservations)) {
            reservations = data.reservations;
            console.log('‚úÖ Data has reservations array with', reservations.length, 'items');
          } else {
            console.warn('‚ö†Ô∏è Unexpected data format:', data);
          }
          
          allReservations = reservations;
          displayReservations(reservations);
          
          if (reservations.length > 0) {
            showMessage(`‚úÖ ${reservations.length} reservation(s) loaded from database`, 'success');
          } else {
            console.log('üì≠ No reservations in database');
          }
        })
        .catch(error => {
          console.error('‚ùå Error loading reservations:', error.message);
          showMessage('Error loading reservations: ' + error.message, 'error');
          document.getElementById('reservationsTableBody').innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #f44336;">‚ö†Ô∏è Error loading reservations: ' + error.message + '</td></tr>';
        });
      }

      // Display Reservations
      function displayReservations(reservations) {
        console.log('üéØ Displaying', reservations ? reservations.length : 0, 'reservations');
        const tbody = document.getElementById('reservationsTableBody');
        
        if (!tbody) {
          console.error('‚ùå Reservations table body element not found!');
          return;
        }

        if (!reservations || reservations.length === 0) {
          console.log('üì≠ No reservations to display');
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">üì≠ No reservations in database yet. Reservations will appear here when customers book tables.</td></tr>';
          return;
        }

        let rowsHTML = '';
        reservations.forEach((reservation, index) => {
          try {
            console.log(`Processing reservation ${index + 1}:`, reservation);
            
            // Format date and time
            let formattedDate = 'N/A';
            if (reservation.reservation_date) {
              try {
                const resDate = new Date(reservation.reservation_date);
                formattedDate = resDate.toLocaleDateString('en-IN');
              } catch (e) {
                formattedDate = reservation.reservation_date;
              }
            }
            
            rowsHTML += `
              <tr style="border-bottom: 2px solid #eee;">
                <td style="padding: 12px;"><strong>#${reservation.id}</strong></td>
                <td style="padding: 12px;">${escapeHtml(reservation.name)}</td>
                <td style="padding: 12px; font-size: 0.9em;">${escapeHtml(reservation.email)}</td>
                <td style="padding: 12px; font-size: 0.9em;">${escapeHtml(reservation.phone)}</td>
                <td style="padding: 12px; font-size: 0.9em;">${formattedDate}</td>
                <td style="padding: 12px; font-size: 0.9em;">${reservation.reservation_time || 'N/A'}</td>
                <td style="padding: 12px; text-align: center;"><strong>${reservation.guests}</strong></td>
                <td style="padding: 12px; font-size: 0.9em;">${reservation.occasion || 'No occasion'}</td>
                <td style="padding: 12px; font-size: 0.85em; max-width: 150px; word-wrap: break-word;">
                  ${reservation.special_requests ? escapeHtml(reservation.special_requests) : '-'}
                </td>
                <td style="padding: 12px;">
                  <button class="btn-edit" onclick="openEditReservationModal(${reservation.id})">Edit</button>
                  <button class="btn-delete" onclick="openDeleteReservationConfirm(${reservation.id})">Delete</button>
                </td>
              </tr>
            `;
          } catch (e) {
            console.error('‚ùå Error processing reservation:', e, reservation);
          }
        });

        if (rowsHTML === '') {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">üì≠ No reservations to display</td></tr>';
        } else {
          tbody.innerHTML = rowsHTML;
        }
        console.log(`‚úÖ Successfully displayed ${reservations.length} reservations`);
      }

      // Update Order Status
      function updateOrderStatus(orderId, newStatus) {
        console.log(`üîÑ Updating order #${orderId} status to: ${newStatus}`);
        const token = sessionStorage.getItem('admin_token');
        
        fetch(`/api/orders/${orderId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order_status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log(`‚úÖ Order status updated`);
            showMessage(`Order #${orderId} status changed to ${newStatus}`, 'success');
            loadOrders();
          } else {
            console.error('‚ùå Error:', data.error);
            showMessage(data.error || 'Error updating order', 'error');
          }
        })
        .catch(error => {
          console.error('‚ùå Error:', error);
          showMessage('Error updating order: ' + error.message, 'error');
        });
      }

      // Open Delete Order Confirmation
      function openDeleteOrderConfirm(orderId) {
        if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
          deleteOrder(orderId);
        }
      }

      // Delete Order
      function deleteOrder(orderId) {
        console.log(`üóëÔ∏è Deleting order #${orderId}`);
        const token = sessionStorage.getItem('admin_token');
        
        fetch(`/api/orders/${orderId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log(`‚úÖ Order deleted`);
            showMessage(`Order #${orderId} deleted successfully`, 'success');
            loadOrders();
          } else {
            console.error('‚ùå Error:', data.error);
            showMessage(data.error || 'Error deleting order', 'error');
          }
        })
        .catch(error => {
          console.error('‚ùå Error:', error);
          showMessage('Error deleting order: ' + error.message, 'error');
        });
      }

      // Open Edit Reservation Modal
      function openEditReservationModal(reservationId) {
        const reservation = allReservations.find(r => r.id === reservationId);
        if (!reservation) {
          console.error('‚ùå Reservation not found');
          return;
        }

        // Store current reservation ID for saving
        window.currentReservationId = reservationId;

        // Populate form with reservation data
        document.getElementById('resName').value = reservation.name;
        document.getElementById('resEmail').value = reservation.email;
        document.getElementById('resPhone').value = reservation.phone;
        document.getElementById('resDate').value = reservation.reservation_date;
        document.getElementById('resTime').value = reservation.reservation_time || '';
        document.getElementById('resGuests').value = reservation.guests;
        document.getElementById('resOccasion').value = reservation.occasion || '';
        document.getElementById('resRequests').value = reservation.special_requests || '';

        document.getElementById('reservationModalTitle').textContent = 'Edit Reservation';
        document.getElementById('reservationModal').classList.add('show');
      }

      // Close Reservation Modal
      function closeReservationModal() {
        document.getElementById('reservationModal').classList.remove('show');
        window.currentReservationId = null;
      }

      // Save Reservation (Create or Update)
      function handleSaveReservation(event) {
        event.preventDefault();

        const name = document.getElementById('resName').value;
        const email = document.getElementById('resEmail').value;
        const phone = document.getElementById('resPhone').value;
        const reservation_date = document.getElementById('resDate').value;
        const reservation_time = document.getElementById('resTime').value;
        const guests = document.getElementById('resGuests').value;
        const occasion = document.getElementById('resOccasion').value;
        const special_requests = document.getElementById('resRequests').value;

        if (!name || !email || !phone || !reservation_date || !guests) {
          showMessage('Please fill in all required fields', 'error');
          return;
        }

        const token = sessionStorage.getItem('admin_token');
        const isUpdate = window.currentReservationId ? true : false;
        const url = isUpdate ? `/api/reservations/${window.currentReservationId}` : '/api/reservations';
        const method = isUpdate ? 'PUT' : 'POST';

        const body = {
          name, email, phone, reservation_date, reservation_time, guests, occasion, special_requests
        };

        console.log(`${isUpdate ? '‚úèÔ∏è Updating' : '‚ú® Creating'} reservation:`, body);

        fetch(url, {
          method: method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log(`‚úÖ Reservation ${isUpdate ? 'updated' : 'created'}`);
            closeReservationModal();
            document.getElementById('reservationForm').reset();
            loadReservations();
            showMessage(`Reservation ${isUpdate ? 'updated' : 'created'} successfully`, 'success');
          } else {
            console.error('‚ùå Error:', data.error);
            showMessage(data.error || 'Error saving reservation', 'error');
          }
        })
        .catch(error => {
          console.error('‚ùå Error:', error);
          showMessage('Error saving reservation: ' + error.message, 'error');
        });
      }

      // Open Delete Reservation Confirmation
      function openDeleteReservationConfirm(reservationId) {
        if (confirm('Are you sure you want to delete this reservation? This action cannot be undone.')) {
          deleteReservation(reservationId);
        }
      }

      // Delete Reservation
      function deleteReservation(reservationId) {
        console.log(`üóëÔ∏è Deleting reservation #${reservationId}`);
        const token = sessionStorage.getItem('admin_token');
        
        fetch(`/api/reservations/${reservationId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log(`‚úÖ Reservation deleted`);
            showMessage(`Reservation #${reservationId} deleted successfully`, 'success');
            loadReservations();
          } else {
            console.error('‚ùå Error:', data.error);
            showMessage(data.error || 'Error deleting reservation', 'error');
          }
        })
        .catch(error => {
          console.error('‚ùå Error:', error);
          showMessage('Error deleting reservation: ' + error.message, 'error');
        });
      }

      // Search functionality
      document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        
        // Show menu section by default
        document.getElementById('menuSection').classList.add('active');
        document.querySelector('.nav-link').classList.add('active');
        
        loadMenuItems();
        // Also preload orders and reservations in the background
        loadOrders();
        loadReservations();

        document.getElementById('searchBox').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filtered = allItems.filter(item =>
            item.name.toLowerCase().includes(searchTerm) ||
            item.description.toLowerCase().includes(searchTerm) ||
            item.category.toLowerCase().includes(searchTerm)
          );
          displayItems(filtered);
        });
      });

      // Show message
      function showMessage(text, type) {
        // Try to find message container in active section or menu section
        let container = document.getElementById('messageContainer');
        if (!container) {
          // Create a temporary message container if none exists
          const activeSection = document.querySelector('.section.active');
          if (activeSection) {
            container = document.createElement('div');
            container.id = 'messageContainer';
            activeSection.insertBefore(container, activeSection.firstChild.nextSibling);
          } else {
            console.error('No active section found for message display');
            alert(text); // Fallback to alert
            return;
          }
        }
        container.innerHTML = `<div class="message ${type}">${text}</div>`;
        const messageEl = container.querySelector('.message');
        if (messageEl) {
          messageEl.style.display = 'block';
        }
        setTimeout(() => {
          container.innerHTML = '';
        }, 4000);
      }

      // Logout
      function handleLogout() {
        const token = sessionStorage.getItem('admin_token');
        fetch('/api/admin/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }).then(() => {
          sessionStorage.removeItem('admin_token');
          window.location.href = 'admin.html';
        });
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
      }
    </script>
  </body>
</html>

