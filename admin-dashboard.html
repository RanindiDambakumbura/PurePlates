<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="public/vite.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - PurePlates</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
      }

      .sidebar {
        background: linear-gradient(135deg, #2d5016 0%, #6b8e23 100%);
        color: white;
        padding: 30px 20px;
        display: flex;
        flex-direction: column;
      }

      .sidebar-logo {
        font-size: 1.4em;
        font-weight: bold;
        margin-bottom: 40px;
        text-align: center;
      }

      .sidebar-menu {
        flex: 1;
      }

      .sidebar-menu ul {
        list-style: none;
      }

      .sidebar-menu li {
        margin-bottom: 15px;
      }

      .sidebar-menu a {
        color: white;
        text-decoration: none;
        padding: 12px;
        display: block;
        border-radius: 6px;
        transition: all 0.3s;
      }

      .sidebar-menu a:hover,
      .sidebar-menu a.active {
        background: rgba(255, 255, 255, 0.2);
      }

      .logout-button {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        width: 100%;
      }

      .logout-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .main-content {
        padding: 30px;
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-header h1 {
        color: #2d5016;
        margin-bottom: 10px;
      }

      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .action-bar button {
        background: linear-gradient(135deg, #2d5016 0%, #6b8e23 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      .action-bar button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(45, 80, 22, 0.3);
      }

      .search-box {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        width: 250px;
        font-size: 1em;
      }

      .table-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #f0f0f0;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #2d5016;
        border-bottom: 2px solid #ddd;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f9f9f9;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .btn-edit,
      .btn-delete {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        font-size: 0.9em;
      }

      .btn-edit {
        background: #4CAF50;
        color: white;
      }

      .btn-edit:hover {
        background: #45a049;
      }

      .btn-delete {
        background: #f44336;
        color: white;
      }

      .btn-delete:hover {
        background: #da190b;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        color: #2d5016;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #999;
      }

      .close-button:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1em;
        font-family: inherit;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2d5016;
        box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
      }

      .modal-footer button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
      }

      .btn-save {
        background: linear-gradient(135deg, #2d5016 0%, #6b8e23 100%);
        color: white;
      }

      .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(45, 80, 22, 0.3);
      }

      .btn-cancel {
        background: #ccc;
        color: #333;
      }

      .btn-cancel:hover {
        background: #999;
      }

      .message {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #f5c6cb;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .empty-state p {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-logo">üçΩÔ∏è PurePlates Admin</div>
        <div class="sidebar-menu">
          <ul>
            <li><a href="#" class="active">üìã Menu Items</a></li>
            <li><a href="#orders">üì¶ Orders</a></li>
            <li><a href="#reservations">üìÖ Reservations</a></li>
            <li><a href="#users">üë• Users</a></li>
          </ul>
        </div>
        <button class="logout-button" onclick="handleLogout()">üö™ Logout</button>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="page-header">
          <h1>Menu Items Management</h1>
          <p>Create, update, and delete menu items</p>
        </div>

        <div id="messageContainer"></div>

        <div class="action-bar">
          <input type="text" class="search-box" id="searchBox" placeholder="Search menu items...">
          <button onclick="openAddItemModal()">‚ûï Add New Item</button>
        </div>

        <div class="table-container">
          <table id="itemsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price (Rs.)</th>
                <th>Category</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody">
              <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add New Item</h2>
          <button class="close-button" onclick="closeItemModal()">‚úï</button>
        </div>

        <form id="itemForm" onsubmit="handleSaveItem(event)">
          <div class="form-group">
            <label for="itemName">Item Name *</label>
            <input type="text" id="itemName" placeholder="e.g., Garden Fresh Salad" required>
          </div>

          <div class="form-group">
            <label for="itemDescription">Description *</label>
            <textarea id="itemDescription" placeholder="e.g., Mixed greens with fresh vegetables" rows="3" required></textarea>
          </div>

          <div class="form-group">
            <label for="itemPrice">Price (Rs.) *</label>
            <input type="number" id="itemPrice" placeholder="e.g., 1200" min="0" step="1" required>
          </div>

          <div class="form-group">
            <label for="itemCategory">Category *</label>
            <select id="itemCategory" required>
              <option value="">Select Category</option>
              <option value="Appetizers">Appetizers</option>
              <option value="Main Courses">Main Courses</option>
              <option value="Desserts">Desserts</option>
              <option value="Beverages">Beverages</option>
            </select>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeItemModal()">Cancel</button>
            <button type="submit" class="btn-save">Save Item</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
      <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
          <h2>Confirm Delete</h2>
          <button class="close-button" onclick="closeConfirmModal()">‚úï</button>
        </div>

        <p style="margin-bottom: 20px; color: #666;">Are you sure you want to delete this item? This action cannot be undone.</p>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
          <button type="button" class="btn-delete" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>

    <script>
      let currentItemId = null;
      let itemToDelete = null;
      let allItems = [];

      // Check if user is logged in
      function checkAuth() {
        const token = sessionStorage.getItem('admin_token');
        if (!token) {
          window.location.href = 'admin.html';
        }
      }

      // Load menu items on page load
      function loadMenuItems() {
        fetch('/api/menu-items')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              allItems = data.items;
              displayItems(allItems);
            } else {
              showMessage('Error loading menu items', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showMessage('Error loading menu items: ' + error.message, 'error');
          });
      }

      // Display items in table
      function displayItems(items) {
        const tbody = document.getElementById('itemsTableBody');
        
        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><p>No menu items found. Click "Add New Item" to create one.</p></td></tr>';
          return;
        }

        tbody.innerHTML = items.map(item => `
          <tr>
            <td>#${item.id}</td>
            <td><strong>${escapeHtml(item.name)}</strong></td>
            <td>${escapeHtml(item.description)}</td>
            <td>Rs. ${item.price.toLocaleString('en-IN')}</td>
            <td><span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">${escapeHtml(item.category)}</span></td>
            <td>
              <div class="action-buttons">
                <button class="btn-edit" onclick="openEditItemModal(${item.id})">Edit</button>
                <button class="btn-delete" onclick="openDeleteConfirm(${item.id})">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      // Open modal to add new item
      function openAddItemModal() {
        currentItemId = null;
        document.getElementById('itemForm').reset();
        document.getElementById('modalTitle').textContent = 'Add New Item';
        document.getElementById('itemModal').classList.add('show');
      }

      // Open modal to edit item
      function openEditItemModal(id) {
        const item = allItems.find(i => i.id === id);
        if (!item) return;

        currentItemId = id;
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemDescription').value = item.description;
        document.getElementById('itemPrice').value = item.price;
        document.getElementById('itemCategory').value = item.category;
        document.getElementById('modalTitle').textContent = 'Edit Item';
        document.getElementById('itemModal').classList.add('show');
      }

      // Close modal
      function closeItemModal() {
        document.getElementById('itemModal').classList.remove('show');
        currentItemId = null;
      }

      // Save item (create or update)
      function handleSaveItem(event) {
        event.preventDefault();

        const name = document.getElementById('itemName').value;
        const description = document.getElementById('itemDescription').value;
        const price = document.getElementById('itemPrice').value;
        const category = document.getElementById('itemCategory').value;
        const token = sessionStorage.getItem('admin_token');

        const itemData = { name, description, price: parseInt(price), category };
        const method = currentItemId ? 'PUT' : 'POST';
        const url = currentItemId ? `/api/menu-items/${currentItemId}` : '/api/menu-items';

        fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(itemData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            closeItemModal();
            loadMenuItems();
            showMessage(currentItemId ? 'Item updated successfully' : 'Item created successfully', 'success');
          } else {
            showMessage(data.error || 'Error saving item', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showMessage('Error saving item: ' + error.message, 'error');
        });
      }

      // Delete confirmation
      function openDeleteConfirm(id) {
        itemToDelete = id;
        document.getElementById('confirmModal').classList.add('show');
      }

      function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('show');
        itemToDelete = null;
      }

      function confirmDelete() {
        if (!itemToDelete) return;

        const token = sessionStorage.getItem('admin_token');

        fetch(`/api/menu-items/${itemToDelete}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            closeConfirmModal();
            loadMenuItems();
            showMessage('Item deleted successfully', 'success');
          } else {
            showMessage(data.error || 'Error deleting item', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showMessage('Error deleting item: ' + error.message, 'error');
        });
      }

      // Search functionality
      document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadMenuItems();

        document.getElementById('searchBox').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filtered = allItems.filter(item =>
            item.name.toLowerCase().includes(searchTerm) ||
            item.description.toLowerCase().includes(searchTerm) ||
            item.category.toLowerCase().includes(searchTerm)
          );
          displayItems(filtered);
        });
      });

      // Show message
      function showMessage(text, type) {
        const container = document.getElementById('messageContainer');
        container.innerHTML = `<div class="message ${type}">${text}</div>`;
        container.querySelector('.message').style.display = 'block';
        setTimeout(() => {
          container.innerHTML = '';
        }, 4000);
      }

      // Logout
      function handleLogout() {
        const token = sessionStorage.getItem('admin_token');
        fetch('/api/admin/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }).then(() => {
          sessionStorage.removeItem('admin_token');
          window.location.href = 'admin.html';
        });
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
      }
    </script>
  </body>
</html>
